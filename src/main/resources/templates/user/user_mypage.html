<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
                  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ ì €ì •ë³´</title>
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/MailForwarding.css">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/user_mypage.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>ğŸ¬</text></svg>">
</head>
<style>
	#Logout{
	background-color: #007bff;
	border-radius: 5px;
	width: 100px;
	text-align: center;
	transition: background-color 0.3s ease;
	}
	#Logout > a {
	color: white;
	text-decoration: none;
	}
	
	#Logout:hover {
	background-color: #0056b3;
	}
</style>
<body>
<script>
	function toggleMenu() {
	  const menu = document.getElementById("menu-list");
	  if(menu.style.display === "none" || menu.style.display === "") {
	    menu.style.display = "block";
	  } else {
	    menu.style.display = "none";
	  }
	}
</script>

	
	<div class="user-info-outer">
		<div class="user-info-box">
			
			
			
			
<!-- í”„ë¡œí•„ì´ë¯¸ì§€ -->
<div class="profile-top">
        <button class="menu-btn" onclick="toggleMenu()">ë©”ë‰´</button>
        <div id="menu-list">
            <!-- í™ˆ ë°”ë¡œê°€ê¸° -->
            <form action="/" method="get" style="margin-bottom:10px;">
                <button type="submit" class="home-btn">í™ˆ ë°”ë¡œê°€ê¸°</button>
            </form>

            <!-- ë‚´ ì •ë³´ ìˆ˜ì • -->
            <form action="/UserEditForm" method="Get" style="margin-bottom:10px;">
                <button type="submit">ë‚´ ì •ë³´ ìˆ˜ì •</button>
            </form>

            <!-- íƒˆí‡´ -->
            <form th:action="@{/UserDelete}" method="post">
                <button type="submit"
                        onclick="return confirm('ì •ë§ íƒˆí‡´ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
                        style="background-color: red; color: white;">íšŒì› íƒˆí‡´</button>
            </form>
               </div>
    </div>
			<div id="resultMessage" style="text-align:center; color: green; margin-bottom:10px;"></div>
			<img id="userProfilePicture" onclick="startUpload()" th:src="@{'/images/profile/' + ${profileFileName}}" alt="í”„ë¡œí•„ ì‚¬ì§„">
			<form id="profileUploadForm" method="post" enctype="multipart/form-data">
			    <div>
			        <input type="file" id="profileImageInput" name="file" accept="image/*" required style = "display: none;">
			    </div>
			</form>
			<table>
				<tr>
					<td>ì´ë©”ì¼: <span sec:authentication="principal.username"></span></td>
				</tr>
				<tr>
					<td>ì´ë¦„: <span sec:authentication="principal.pname"></span></td>
				</tr>
				<tr>
					<td>ë‹‰ë„¤ì„: <span sec:authentication="principal.nickname"></span></td>
				</tr>
				<tr>
					<td>ìƒë…„ì›”ì¼:<span sec:authentication="principal.birthdate"></span></td>
				</tr>
				<tr>
				</tr>
			</table>
	<!-- ì‚¬ìš©ì ì¢‹ì•„ìš” ëª©ë¡ MODAL -->
	<button id="showLikedMoviesBtn" onclick="openLikeModal()">
	    ì¢‹ì•„ìš” ëª©ë¡ ë³´ê¸°
	</button>
	<br>
	<div id="likeModal" class="modal" style="display:none;">
	
		<div class ="modal-content">
				<span class = "close-btn">ë‹«ê¸°</span>
				<h3>
					<span sec:authentication="principal.nickname"></span>ë‹˜ì˜ ì¢‹ì•„ìš” ëª©ë¡ 
				</h3>
				
				<!-- ì‚¬ìš©ì ì¢‹ì•„ìš” ëª©ë¡ë³´ì—¬ì£¼ëŠ” ì»¨í…Œì´ë„ˆ -->
				<div id="likedMoviesContainer">
				</div>		
				
				<div id="emptyMessage" style="display:none;">
					<p>ì•„ì§ ì¢‹ì•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
				</div>
		</div>
	</div>
				
	    <!-- ì‚¬ìš©ì ë¦¬ë·° ëª©ë¡ MODAL -->
		<button id="showReviewMoviesBtn" onclick="openReviewModal()">
		    ë¦¬ë·° ëª©ë¡ ë³´ê¸°
		</button>
		<div id="ReviewModal" class="modal" style="display:none;">
		
			<div class ="modal-content-Review">
				<span class = "close-btn2">ë‹«ê¸°</span>
				<h3><span sec:authentication="principal.nickname"></span>ë‹˜ì˜ ë¦¬ë·° ëª©ë¡</h3>
				
				<!-- ì‚¬ìš©ì ì¢‹ì•„ìš” ëª©ë¡ ì»¨í…Œì´ë„ˆ -->
				<div id="ReviewMoviesContainer"></div>		
					<div id="emptyReviewMessage" style="display:none;">
						<p>ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
					</div>
			</div>
		</div>
		<br>
		
		<span sec:authorize="hasRole('ROLE_ADMIN')">
	        <b><a href="/Admin/AdminHome">ì‚¬ì´íŠ¸ê´€ë¦¬</a></b>
	    </span>
		
		<br>
		<div class="Logout" id="Logout" sec:authorize="isAuthenticated()">
		    <a href="javascript:void(0);" onclick="requestLogout()">ë¡œê·¸ì•„ì›ƒ</a>
		    </div>
		</div>
	</div>


<!------------------------------------------------------------------>
<script th:inline="javascript">
    const LOGGED_IN_USER_ID = [[${currentUserId}]];
    console.log("ì£¼ì…ëœ userId:", LOGGED_IN_USER_ID);
    if (LOGGED_IN_USER_ID) {
        loadProfileImage(LOGGED_IN_USER_ID); 
    }
</script>
<script>
function requestLogout() {
    // â­ï¸ Spring Securityê°€ ì²˜ë¦¬í•˜ë„ë¡ ì„¤ì •í•œ ê²½ë¡œë¡œ POST ìš”ì²­
    fetch('/api/user/logout', { 
        method: 'POST' 
    })
    .then(response => response.json())
    .then(data => {
        // â­ï¸ ì„œë²„ê°€ {"success": true}ë¥¼ ë°˜í™˜í–ˆëŠ”ì§€ í™•ì¸
        if (data && data.success === true) {
            // 1. Flutter ì•±ì— ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì•Œë¦¼ (JavaScript Channel ì‚¬ìš©)
            if (typeof ProfileChannel !== 'undefined') {
                ProfileChannel.postMessage('logout_success'); 
            }
            
            // 2. ì›¹ë·° ìì²´ë¥¼ ë¡œê·¸ì¸ í˜ì´ì§€ë‚˜ í™ˆìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜
            window.location.href = '/login'; 
        } else {
            console.error('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹¤íŒ¨:', data.message);
        }
    })
    .catch(error => {
        console.error('ë¡œê·¸ì•„ì›ƒ ì¤‘ í†µì‹  ì˜¤ë¥˜ ë°œìƒ:', error);
    });
}

</script>

<script>
	function updateProfileImage(url) {
  		const img = document.getElementById("profile-img");
    	if (img) img.src = url;
	}
	function handleUploadFailure(msg){
	  alert(msg);
	}
	function requestUpload(){
	  ProfileChannel.postMessage("upload_start");
	}
</script>
<script src="/js/upload.js"></script>
		
<!-- í‘¸í„° -->
<div th:insert="index/index :: footer"></div>
<script src="js/footer.js"></script>

<!-- ì‚¬ìš©ì ì¢‹ì•„ìš” ëª©ë¡.js-->
<script src = "js/user_LikeListBtn.js" ></script>

<!-- ë¦¬ë·° ì‘ì„± ëª©ë¡.js -->
<script src = "js/user_ReviewListBtn.js"></script>

</body>
</html>
